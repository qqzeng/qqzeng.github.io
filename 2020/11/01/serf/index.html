<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-Hans">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<meta name="theme-color" content="#222">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 2px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>








<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/avastar-circle-32x32.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/avastar-circle-16x16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="gossip,集群成员管理,故障检测,组成员协议,">










<meta name="description" content="上一篇文章简要剖析了基于 SWIM+Lifeguard 的组成员协议 memberlist 协议库的基本原理，另外，也阐明了如何关联 memberlist 和上层应用，即 memberlist 暴露一些 Delegate 接口以让上层应用能够  hook 到协议层内部，以为上层应用提供协议用途之外的能力。而 Serf 基于 memberlist 为分布式应用提供诸如集群成员管理、集成成员故障检测以">
<meta name="keywords" content="gossip,集群成员管理,故障检测,组成员协议">
<meta property="og:type" content="article">
<meta property="og:title" content="Serf 原理剖析">
<meta property="og:url" content="https://qtozeng.top/2020/11/01/serf/index.html">
<meta property="og:site_name" content="一抹光辉油彩">
<meta property="og:description" content="上一篇文章简要剖析了基于 SWIM+Lifeguard 的组成员协议 memberlist 协议库的基本原理，另外，也阐明了如何关联 memberlist 和上层应用，即 memberlist 暴露一些 Delegate 接口以让上层应用能够  hook 到协议层内部，以为上层应用提供协议用途之外的能力。而 Serf 基于 memberlist 为分布式应用提供诸如集群成员管理、集成成员故障检测以">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-11-03T00:31:02.490Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Serf 原理剖析">
<meta name="twitter:description" content="上一篇文章简要剖析了基于 SWIM+Lifeguard 的组成员协议 memberlist 协议库的基本原理，另外，也阐明了如何关联 memberlist 和上层应用，即 memberlist 暴露一些 Delegate 接口以让上层应用能够  hook 到协议层内部，以为上层应用提供协议用途之外的能力。而 Serf 基于 memberlist 为分布式应用提供诸如集群成员管理、集成成员故障检测以">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://qtozeng.top/2020/11/01/serf/">





  <title>Serf 原理剖析 | 一抹光辉油彩</title>
  





  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?32c9335b479b9d4ab2d32b6e9dd59ed8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->




</head>
<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">一抹光辉油彩</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <h1 class="site-subtitle" itemprop="description"></h1>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br>
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            归档
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://qtozeng.top/2020/11/01/serf/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Zeng Qiaoqiao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="一抹光辉油彩">
    </span>

    
      <header class="post-header">

        
        
          <h2 class="post-title" itemprop="name headline">Serf 原理剖析</h2>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-11-01T18:07:15+08:00">
                2020-11-01
              </time>
            

            

            


          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式系统/" itemprop="url" rel="index">
                    <span itemprop="name">分布式系统</span>
                  </a>
                </span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing">
                  <a href="/categories/分布式系统/组成员协议/" itemprop="url" rel="index">
                    <span itemprop="name">组成员协议</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  3,761
                </span>
              words

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  13
                </span>
              mins
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>上一篇文章简要剖析了基于 SWIM+Lifeguard 的组成员协议 memberlist 协议库的基本原理，另外，也阐明了如何关联 memberlist 和上层应用，即 memberlist 暴露一些 Delegate 接口以让上层应用能够  hook 到协议层内部，以为上层应用提供协议用途之外的能力。而 Serf 基于 memberlist 为分布式应用提供诸如集群成员管理、集成成员故障检测以及自定义事件传播等功能，显然，Serf 是一个完全去中心化的、具备强大故障容忍能力的工具。本文简要阐述 Serf 原理，以了解如何基于 memberlist 构建能解决分布式场景下典型问题的工具。</p>
<a id="more"></a>
<p>本文非详细的源码解读教程，只会介绍 Serf 的基本特性以及组成 Serf 的关键组件。因此，若读者有兴趣，可在参阅本文之后详细阅读源码。另外，建议读者在阅读本文前，先了解上一（几）篇文章的内容，这有助于读者理解源码，可参考【这里】和【这里】。最后，本文的分析基于版本。</p>
<p>具体地，本文首先阐述 Serf 的典型实践场景以及提供的基本能力，即了解 Serf 能够解决分布式系统中的哪些问题，而这些能力是通过 hook 到 memberlist 协议库底层来实现的。接下来，重点剖析 Serf 所包含的关键组件，关键组件即代表着 Serf 的基本原理，也代表着对外提供能力的基础构建块，这同样有助于把握阅读源码时的切入点和脉络。最后，简单阐述 Serf 如何利用底层协议库 memberlist 为其提供的 hook 接口。</p>
<h2 id="serf-的应用场景和基本能力"><a href="#serf-的应用场景和基本能力" class="headerlink" title="serf 的应用场景和基本能力"></a>serf 的应用场景和基本能力</h2><p>Serf 基于组成员协议库 memberlist 并将 memberlist 拥有的能力进行“变现”和输出。上文提到，Serf 能够应用于集群成员管理和集成成员故障检测等场景，这些都是基于底层的 memberlist 协议库实现的。另外，Serf 还支持自定义事件和查询的广播。</p>
<p>具体地，关于集成成员管理，Serf 可以为我们维护集群成员列表，同时，在集成成员动态发生变化时（如节点加入、离开或者失败等），能够执行预先自定义的脚本。这拥有很多实际应用，比如 Serf 实例可以我们负载均衡器维护后端的一系列业务服务器，以使得在业务服务器集群在动态扩张和收缩时（即节点上线和下线），能够即时通知负载均衡器触发相应动作。类似地，它也可以为后端业务服务器动态维护一个底层的存储实例列表。</p>
<p>另外，关于集群成员故障检测，Serf 可自动且即时（秒级）地发现集群中的故障节点，并且通知集群中其它存活的成员，同时，还可以自动触发预先配置的对应事件关联的 handler。且默认情况下，Serf 会自动周期性的重连失败的节点，以使得集群不会因为节点的短暂故障下线而处于非预期状态。</p>
<p>其次，Serf 可以为我们传播自定义（用户）事件（Event），即 Serf 可以将用户自定义的事件广播到集群（显然集群本身的事件，如节点加入等，也可以注册相应的 handler），因此，理论上所有成员都可以收到此事件消息，因为我们可以为事件注册对应的 handler，这可以让节点在收到这些事件后触发动作。此外，我们也可以设置 filter，以指定事件的目标发送节点集合。这同样拥有很多实际应用，比如我们可以集群就绪后通过 Serf 向集群中广播服务部署事件事件以触发节点上的服务部署进程。类似地，我们可以定配置变更的事件，以让节点重新加载配置。值得注意的是，用户自定义事件是一次性的单向广播（fire-and-forget），换言之，收到事件消息的节点只需触发关联的 handler 即可，无需响应或返回执行结果。</p>
<p>最后，Serf 还允许我们将自定义查询（Query）广播到集群，查询是基于事件的，换言之，其也是一种用户自定义事件，但其提供了一种简单的实时请求-响应机制，即收到查询消息的节点可以简单应答也可以执行对应的 handler，并将执行结果返回，因此，Query 能够提供更强的能力。基于此，我们可以实时地收集运行中的集群的指标信息，如通过自定义查询以定期收集节点的负载信息。但值得注意的是，查询消息可能不会被所有节点收到并处理，考虑到自定义查询侧重于请求的实时性，因此在广播自查询时，若有节点正处于故障状态，或者处于不同的网络分区，此节点将不会收到此查询消息，且后续 Serf 也不会重新广播此查询消息，<strong>这不同于自定义事件的广播。</strong></p>
<h2 id="serf-的关键组件"><a href="#serf-的关键组件" class="headerlink" title="serf 的关键组件"></a>serf 的关键组件</h2><p>本节通过阐述 Serf 的几个关键组件来剖析 Serf 的基本原理。如下图所示，Serf 允许我们执行特定的命令来操作 Serf 集群。比如，我们可通过执行<code>serf agent</code>以默认配置启动一个或多个 Serf 节点，此时，即存在一个或多个包含单节点的集群，然后可以执行<code>serf join node-addr</code>来将隔离的集群进行合并，当然，也叫可在启动 agent 的同时加入已存在的集群，通过<code>serf agent -join=node-addr</code>来实现。上层的命令程序将通过 RPCClient 发送相应的 rpc 请求到 agent IPC，agent IPC 在收到 rpc 请求后，充当一个请求路由器 handler 的功能，随即将请求转发给 serf agent 处理，serf agent 进一步将请求中继给 serf 实例处理，serf 实例是核心枢纽，它会底层的 memberlist 协议库以及各个关键组件（如Query、EventHandler、Snapshotter、Coalescence等）对请求进行处理。最后，若请求需要响应返回，则通过 udp 发送请求执行结果。</p>
<h3 id="serf-agent-启动逻辑"><a href="#serf-agent-启动逻辑" class="headerlink" title="serf agent 启动逻辑"></a>serf agent 启动逻辑</h3><p>基于上述 serf 基本执行流程，简单介绍 serf agent 启动逻辑：当用户执行<code>serf agent</code>命令时，它首先配置 Serf agent，比如配置 agent 之间的通信地址、初始化底层依赖的 memberlist 配置以及其它配置，随后创建 agent 实例。接下来，它开始启动 agent，在此过程中，其首先注册自定义事件 handler（若有设置），然后正式启动 agent，在启动 agent 的过程中，创建 Serf 实例，同时启动事件监听和处理循环，并在设置 rpc listener 后启动 agent IPC 用以响应和处理用户执行的命令。最后，它开始加入指定的 agent 节点（若有配置），然后等待退出信号。这即为一个 Serf agent 的启动逻辑。当然，在创建 Serf 实例的过程中，还做了其它一系列操作，比如创建 Query，并启动 Query 处理循环，创建 Coordinate 系统、加载 Snapshot 并恢复、配置事件和查询的广播队列、创建 memberlist 实例，最后启动一系列异步 goroutine，用于回收故障节点、周期性重连故障节点等。</p>
<p>在梳理完 serf agent 启动逻辑后，下面简要介绍 serf 依托的各个组件的基本原理：</p>
<h3 id="lamport-时钟"><a href="#lamport-时钟" class="headerlink" title="lamport 时钟"></a>lamport 时钟</h3><p><a href="https://qtozeng.top/2018/11/05/%E5%88%86%E5%B8%83%E5%BC%8F%E7%B3%BB%E7%BB%9F%E6%97%B6%E9%97%B4%E3%80%81%E6%97%B6%E9%92%9F%E4%B8%8E%E4%BA%8B%E4%BB%B6%E9%A1%BA%E5%BA%8F/">lamport 时钟</a>用于规定分布式系统中事件发生的先后顺序。考虑到机器的物理时钟因各种原因（如时钟漂移）而并不准确，因此，Leslie Lamport 提出了逻辑时钟的概念，其大致是基于事件发生的因果关系来定义分布式系统中事件的发生顺序，它虽然不能保证此顺序即为实际以物理时钟为依据的排序结果，但它保证能够正确排列系统中具有因果关系的事件，这使得分布式系统在逻辑上不会颠倒具有因果关系的事件的发生顺序，这在绝大部分情况下是足够的。</p>
<h3 id="coordinate-系统"><a href="#coordinate-系统" class="headerlink" title="coordinate 系统"></a>coordinate 系统</h3><p>coordinate 系统是基于 <a href="https://www.cs.ucsb.edu/~ravenben/classes/276/papers/vivaldi-sigcomm04.pdf" target="_blank" rel="noopener">vivaldi 算法</a>，其通过启发式学习算法，不断计算节点通信时的 RTT 来动态学习系统网络拓扑的算法。在分布式系统中，节点若能知道整个系统中节点分布，即网络的拓扑结构，那么其可作为节点之间进行通信的依据，即节点可选择离其拓扑距离最近的 k 个节点进行广播通信，这样可以尽可能减少网络中充斥着大量的消息，即可以避免网络风暴，而且，通过调整 k 的大小，可以个性消息的传播速度、效率以及对网络带宽的影响。</p>
<h3 id="coalescence-机制"><a href="#coalescence-机制" class="headerlink" title="coalescence 机制"></a>coalescence 机制</h3><p>coalescence 机制指的是 serf 可将指定时间窗口内的连续若干个 event 合并成一个 event 进行广播发送的机制。比如，当集群中有 5 个成员（几乎）同时加入时，在满足要求的前提下，coalescence 机制会对这 5 条 event 进行合并，因此，只会压入一条  event 到 event channel，避免了集群因这些事件的影响而出现的潜在的 flapping 行为。有两个参数同 coalescence 机制相关，一个是决定执行合并操作的周期，另一个参数指定了允许持续合并的 event 之间的最大时间间隔，即在超过此时间间隔后，即使未达到合并操作周期，也必须执行合并操作，将 event 压入到 event channel。</p>
<h3 id="snapshotter-机制"><a href="#snapshotter-机制" class="headerlink" title="snapshotter 机制"></a>snapshotter 机制</h3><p>serf 提供的 snapshotter 机制类似于日志的快照机制，snapshotter 机制允许在 serf  失败重启时，通过加载保存有一系列事务数据的快照文件以帮助其快速恢复到宕机前的状态。具体地，agent 收到消息时，snapshotter 机制将成员事件以及对应的 lamport 时钟值写入文件，并定期对文件执行 checkpoint 和 roll over 的操作。因此，在 agent 重启时，通过 replay 快照文件所包含的所有成员事件以获取 agent 需要加入的节点的列表，同时，lamport 时钟值还可以避免 replay 过期的事件。</p>
<h3 id="event-处理器"><a href="#event-处理器" class="headerlink" title="event 处理器"></a>event 处理器</h3><p>当执行命令<code>serf event name [payload]</code>，它首先构建对应类型的 rpc 请求头和请求参数，然后基于 RPCClient 发送此 rpc 请求，请求会被 agent IPC  接收，然后转交给 agent 处理，agent 进一步转交给 serf 实例处理，serf 实例首先对 event 消息进行简单检查，检查项包括消息大小是否超过限制等，然后更新 serf 实例本地的 lamport 时钟，接着开始处理 event 消息，消息处理逻辑比较简单，在判断消息是否过期（serf 会维护最近收到的 event 缓冲队列，因此，若收到的消息比缓冲中最旧的消息更旧，则证明其是过期的消息），同时判断消息是否已被处理（即判断此消息是否存在于缓冲队列中），在所有检查通过后，其将消息压入 event channel，这使得 event 可以被 event handler、query 以及 snapshotter 组件接收并进行针对性处理。最后，将此 event 消息加入到 event 关联的广播消息队列中，此广播消息队列中的消息会附加到 memberlist 协议库的 gossip 消息中广播出去。</p>
<h3 id="query-处理器"><a href="#query-处理器" class="headerlink" title="query 处理器"></a>query 处理器</h3><p>可以通过命令<code>serf query load</code>来向 serf 中发送 query 消息。query 消息的处理过程同 event 处理过程类似。其区别在于，query 消息还可制定响应策略，这包括设置目标节点是否应该返回 ack，以及目标节点是否允许再一次此 query 消息。此外，agent IPC 会为所有的目标接收节点设置一个响应超时时限，在定时器超时后，直接返回，不会再等待节点返回 ack 或执行结果。</p>
<h3 id="密钥管理器"><a href="#密钥管理器" class="headerlink" title="密钥管理器"></a>密钥管理器</h3><p>密钥处理器（Key Manager）用于管理 serf 集群中的加密密钥（encryption keyring）。</p>
<h2 id="serf-如何利用协议库提供的-hook-接口"><a href="#serf-如何利用协议库提供的-hook-接口" class="headerlink" title="serf 如何利用协议库提供的 hook 接口"></a>serf 如何利用协议库提供的 hook 接口</h2><p>最后，我们阐述 serf 和底层协议库是如何交互的，即 serf 如何利用底层协议库的 hook 接口。首先，serf 实现了 memberlist 提供的 Delegate 接口。其中，</p>
<ul>
<li><p>NodeMeta 接口使得 serf 实例将其 tags 作为节点的元数据通过广播发送到各个节点；</p>
</li>
<li><p>NotifyMsg 接口使得 serf 借助底层协议库传播自自定义的一系列 userMsg，因此，此接口即可作为 userMsg 的 dispatcher，根据 userMsg 具体类型来调用 serf 实例提供对应的 handler。换言之，上一篇文章所说的 memberlist 在收到 userMsg 时会回调上层应用 serf 的逻辑，即将此 userMsg 交由 serf 处理；</p>
</li>
<li>GetBroadcasts 接口使得 serf 实例借助底层协议库基于 gossip 的消息广播机制来广播自己需要广播的消息，即将 serf 层需要广播的消息附加到底层 memberlist 的 gossip 消息中来达到发送到各节点的目的；其中，serf 层包含了诸如事件广播队列 eventBroadcasts、查询广播队列 queryBroadcasts，以及一个<strong>通用广播队列</strong>；</li>
<li>LocalState 接口使得 serf 实例借助底层协议库定期执行的 push-pull-merge 操作来通过 messagePushPull 消息来交换 serf 实例层各节点的本地状态。如实例最后一个处理消息的时间、实例本地的已 left 成员的视图列表等。定期执行这些信息交互，可使得 serf 实例集群状态快速收敛；</li>
<li>最后，MergeRemoteState 接口使得 serf 实例可以处理其它节点发送给它的 messagePushPull 消息，然后，针对消息中的内容，以将其合并到（借助其调整）实例本地存储的状态。如针对源节点发送的已 left 成员视图列表，本节点会当作收到对应 left 成员的 leave 消息。StatusLTimes</li>
</ul>
<p>另外，eventDelegate 各接口的实现，即调用 serf 实例的关联的接口。pingDelegate 也是类似，将 PingVersion 作为 pingMsg 的 payLoad，并将节点的 coordinate 信息编码到 pingMsg 中。</p>
<p>Query</p>
<p>实时性、通过tag过滤目标发送对象、定制返回策略（是否返回Ack以及是否应该继续广播）</p>
<p>传送方式（通过 GetBroadcasts 接口附带出去，event 也是类似）</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/gossip/" rel="tag"># gossip</a>
          
            <a href="/tags/集群成员管理/" rel="tag"># 集群成员管理</a>
          
            <a href="/tags/故障检测/" rel="tag"># 故障检测</a>
          
            <a href="/tags/组成员协议/" rel="tag"># 组成员协议</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div id="needsharebutton-postbottom">
            <span class="btn">
              <i class="fa fa-share-alt" aria-hidden="true"></i>
            </span>
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/09/19/memberlist-原理剖析/" rel="next" title="memberlist 原理剖析">
                <i class="fa fa-chevron-left"></i> memberlist 原理剖析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2021/09/05/浅析组成员资格协议-SWIM/" rel="prev" title="浅析组成员资格协议 SWIM">
                浅析组成员资格协议 SWIM <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div id="gitalk-container"></div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Zeng Qiaoqiao</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">47</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">20</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">58</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/qqzeng" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-globe"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:qtozeng@gmail.com" target="_blank" title="Email">
                      
                        <i class="fa fa-fw fa-envelope"></i>Email</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#serf-的应用场景和基本能力"><span class="nav-number">1.</span> <span class="nav-text">serf 的应用场景和基本能力</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serf-的关键组件"><span class="nav-number">2.</span> <span class="nav-text">serf 的关键组件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#serf-agent-启动逻辑"><span class="nav-number">2.1.</span> <span class="nav-text">serf agent 启动逻辑</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lamport-时钟"><span class="nav-number">2.2.</span> <span class="nav-text">lamport 时钟</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#coordinate-系统"><span class="nav-number">2.3.</span> <span class="nav-text">coordinate 系统</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#coalescence-机制"><span class="nav-number">2.4.</span> <span class="nav-text">coalescence 机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#snapshotter-机制"><span class="nav-number">2.5.</span> <span class="nav-text">snapshotter 机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#event-处理器"><span class="nav-number">2.6.</span> <span class="nav-text">event 处理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#query-处理器"><span class="nav-number">2.7.</span> <span class="nav-text">query 处理器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#密钥管理器"><span class="nav-number">2.8.</span> <span class="nav-text">密钥管理器</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#serf-如何利用协议库提供的-hook-接口"><span class="nav-number">3.</span> <span class="nav-text">serf 如何利用协议库提供的 hook 接口</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zeng Qiaoqiao</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">239.2k</span>
  
</div>


<!--

  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a> v5.1.4</div>

-->




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
  <script src="/js/src/md5.min.js"></script>
   <script type="text/javascript">
        var gitalk = new Gitalk({
          clientID: '254c17f1918f80ab52dd',
          clientSecret: '34c85cd4d80c0f06e9818833a9ae32a9ba4cc669',
          accessToken: '708b17957b91acd33283ceae79fa7a1ad50c714f', 
          repo: 'qqzeng.github.io',
          owner: 'qqzeng',
          admin: ['qqzeng'],
          id: md5(location.pathname),
          distractionFreeMode: 'true'
        })
        gitalk.render('gitalk-container')
    </script>

  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>


  
  
  
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">

  
  
  <script src="/lib/needsharebutton/needsharebutton.js"></script>

  <script>
    
      pbOptions = {};
      
          pbOptions.iconStyle = "box";
      
          pbOptions.boxForm = "horizontal";
      
          pbOptions.position = "bottomCenter";
      
          pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
      
      new needShareButton('#needsharebutton-postbottom', pbOptions);
    
    
  </script>

  

  
  


  

  

  <!-- 代码块复制功能 -->
  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  
  <script>
    $('.highlight').each(function (i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap')
      $(e).after($wrap)
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function (e) {
        var code = $(this).parent().find('.code').find('.line').map(function (i, e) {
          return $(e).text()
        }).toArray().join('\n')
        var ta = document.createElement('textarea')
        document.body.appendChild(ta)
        ta.style.position = 'absolute'
        ta.style.top = '0px'
        ta.style.left = '0px'
        ta.value = code
        ta.select()
        ta.focus()
        var result = document.execCommand('copy')
        document.body.removeChild(ta)
        
          if(result)$(this).text('复制成功')
          else $(this).text('复制失败')
        
        $(this).blur()
      })).on('mouseleave', function (e) {
        var $b = $(this).find('.copy-btn')
        setTimeout(function () {
          $b.text('复制')
        }, 300)
      }).append(e)
    })
  </script><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config("");
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>
</html>
